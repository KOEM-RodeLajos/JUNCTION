<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kereszteződés Diagram</title>
    <style>
        :root {
            --road-width: 100px;
            --arm-length: 100px;
            --border-thick: 2.5px solid black;
            --arrow-color: #8da6d6; /* A nyilak kék színe */
        }

        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f9f9f9;
        }

        /* Fő rács (3x3 grid) */
        .container {
            display: grid;
            grid-template-columns: var(--arm-length) var(--road-width) var(--arm-length);
            grid-template-rows: var(--arm-length) var(--road-width) var(--arm-length);
            background-color: white;
            padding: 10px;
            position: relative;
        }

        /* Cellák általános formázása */
        .cell {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* ---------------- UTAK (KERETEK) ---------------- */

        /* "A" (Felső) kar */
        .cell.top {
            border-left: var(--border-thick);
            border-right: var(--border-thick);
            grid-column: 2;
            grid-row: 1; 
            background: lightgrey;

        }

        /* "B" (Jobb) kar */
        .cell.right {
            border-top: var(--border-thick);
            border-bottom: var(--border-thick);
            grid-column: 3;
            grid-row: 2; 
            background: lightgrey;
        }

        /* "C" (Alsó) kar */
        .cell.bottom {
            border-left: var(--border-thick);
            border-right: var(--border-thick);
            grid-column: 2;
            grid-row: 3; 
            background: lightgrey;
        }

        /* "D" (Bal) kar */
        .cell.left {
            border-top: var(--border-thick);
            border-bottom: var(--border-thick);
            grid-column: 1;
            grid-row: 2; 
            background: lightgrey;
        }

        /* Sarok cellák a sorompó mezőknek */
        .cell.corner {
            background: white;
            position: relative;
        }
        .cell.corner.tl { grid-column: 1; grid-row: 1; }
        .cell.corner.tr { grid-column: 3; grid-row: 1; }
        .cell.corner.br { grid-column: 3; grid-row: 3; }
        .cell.corner.bl { grid-column: 1; grid-row: 3; }

        /* Közép (Nyilak) */
        .cell.center {
            grid-column: 2;
            grid-row: 2;
            position: relative; 
            background: lightgrey;
            border: none;
        }

        .axis-hitbox {
            position: absolute;
            border: none;
            z-index: 4;
            box-sizing: border-box;
        }
        .axis-hitbox.ac {
            left: 35%;
            top: 0;
            width: 30%;
            height: 100%;
        }
        .axis-hitbox.bd {
            left: 0;
            top: 35%;
            width: 100%;
            height: 30%;
        }
        .axis-hitbox.both {
            left: 35%;
            top: 35%;
            width: 30%;
            height: 30%;
            z-index: 6;
        }
        .axis-hitbox.corner {
            border: none;
            z-index: 5;
        }
        .axis-hitbox.ab { left: 65%; top: 0; width: 35%; height: 35%; }
        .axis-hitbox.bc { left: 65%; top: 65%; width: 35%; height: 35%; }
        .axis-hitbox.cd { left: 0; top: 65%; width: 35%; height: 35%; }
        .axis-hitbox.ad { left: 0; top: 0; width: 35%; height: 35%; }

        .axis-corner-indicator {
            position: absolute;
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: #8da6d6;
            font-size: 28px;
            font-weight: bold;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 7;
            pointer-events: none;
        }
        .axis-corner-indicator.on {
            display: flex;
            color: #6c8ecf;
        }
        .axis-corner-indicator::before {
            content: '↔';
            display: block;
            line-height: 1;
            transform-origin: center;
        }
        .axis-corner-indicator.ab::before { transform: rotate(45deg); }
        .axis-corner-indicator.bc::before { transform: rotate(135deg); }
        .axis-corner-indicator.cd::before { transform: rotate(45deg); }
        .axis-corner-indicator.ad::before { transform: rotate(135deg); }
        /* A 35% x 35% sarok-hitboxok közepére igazítva */
        .axis-corner-indicator.ab { left: 84%; top: 16%; transform: translate(-50%, -50%); }
        .axis-corner-indicator.bc { left: 84%; top: 84%; transform: translate(-50%, -50%); }
        .axis-corner-indicator.cd { left: 19%; top: 81%; transform: translate(-50%, -50%); }
        .axis-corner-indicator.ad { left: 19%; top: 19%; transform: translate(-50%, -50%); }

        /* ---------------- INPUT MEZŐK ---------------- */
        
        .data-group {
            text-align: center;
            margin: 2.5px 0;
            z-index: 2;
        }

        input[type="vehicle.number"] {
            font-size: 11px;
            font-weight: bold;
            text-align: center;
            padding: 2.5px;
            width: 40px;
            border: 0.5px solid #777;
        }

        input[type="number"] {
            font-size: 9px;
            font-weight: normal;
            text-align: center;
            padding: 2.5px;
            width: 40px;
            border: 0.5px solid #777;
        }

        input[type="time.number"] {
            font-size: 7px;
            font-weight: normal;
            text-align: center;
            padding: 2.5px;
            width: 40px;
            border: 0.5px solid #777;
        }
        .data-group input[type="time.number"] {
            width: 20px;
            display: inline-block;
            transform: none;
        }

        .label {
            font-size: 6px;
            margin-top: 1px;
            color: #000;
        }

        /* ---------------- ELSŐBBSÉGI SZÁMOK (1, 2, 3, 4) - INPUTKÉNT ---------------- */
        
        /* Specifikus input formázás, hogy szövegnek nézzen ki */
        input.priority-number {
            font-family: Arial, sans-serif; /* Örökölje a fontot */
            font-size: 18px;
            font-weight: bold;
            position: absolute;
            
            /* Input stílusok eltüntetése */
            border: none;
            background: transparent;
            padding: 0;
            margin: 0;
            width: 1.5em; /* Elég széles legyen 1-2 számjegynek */
            text-align: center;
            color: black;
            outline: none; /* Fókusz keret eltüntetése */
            cursor: text; /* Jelezze, hogy írható */
        }

        /* Spinner (fel/le nyilak) eltüntetése Chrome, Safari, Edge, Opera alatt */
        input.priority-number::-webkit-outer-spin-button,
        input.priority-number::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Spinner eltüntetése Firefox alatt */
        input.priority-number {
            -moz-appearance: textfield;
        }

        .pos-A { top: -00px; } 
        .pos-B { right: -00px; } 
        .pos-C { bottom: -00px; } 
        .pos-D { left: -00px; } 


        /* ---------------- CHECKBOXOK ---------------- */
        
        .check-wrapper {
            position: absolute;
        }

        /* Az "A-C" tengely checkboxa (jobb felső sarok a karon belül, de a vonalon kívülre esik a képen) */
        .check-AC {
            top: 5px;
            right: -20px; 
        }

        /* A "B-D" tengely checkboxa (bal felső sarok környéke) */
        .check-BD {
            top: -20px;
            left: 5px;
        }

        input[type="checkbox"] {
            transform: scale(0.75); /* Kisebb checkbox */
            cursor: pointer;
            opacity: 0;
            width: 0;
            height: 0;
            pointer-events: none;
        }

        /* ---------------- KIS KORONGOK (TÁBLÁK) ---------------- */
        .sign {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: white;
            border: 2px solid #333;
            box-shadow: 0 0 2px rgba(0,0,0,0.4);
            z-index: 3;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: bold;
            color: #000;
        }

        /* Jobbra tarts elhelyezés, irányonként a vezető jobb oldalán, a csomópont előtt */
        .sign-A { bottom: 8px; left: 8px; }     /* A (felső kar): jobbra = nyugat */
        .sign-B { top: 8px; left: 8px; }        /* B (jobb kar): jobbra = észak */
        .sign-C { top: 8px; right: 8px; }       /* C (alsó kar): jobbra = kelet */
        .sign-D { bottom: 8px; right: 8px; }    /* D (bal kar): jobbra = dél */

        /* ---------------- SOROMPÓK ---------------- */
        .barrier {
            position: absolute;
            z-index: 2;
            cursor: pointer;
        }
        .barrier .barrier-arm {
            position: absolute;
            background: #555;
            border-radius: 2px;
            box-shadow: 0 0 0 1px #333;
        }
        .barrier .barrier-post {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #666;
            border-radius: 50%;
            box-shadow: 0 0 0 1px #333;
        }
        .barrier.arm-hidden .barrier-arm {
            display: none;
        }
        .barrier.open-short .barrier-arm { }
        .barrier-A.open-short .barrier-arm,
        .barrier-C.open-short .barrier-arm {
            width: 12px;
        }
        .barrier-B.open-short .barrier-arm,
        .barrier-D.open-short .barrier-arm {
            height: 12px;
        }
        .barrier-C.open-short .barrier-arm {
            left: auto;
            right: 0;
        }
        .barrier-D.open-short .barrier-arm {
            top: auto;
            bottom: 0;
        }
        .barrier-A {
            width: 52px;
            height: 4px;
            bottom: 2px;
            left: 16%;
            transform: translateX(-50%);
        }
        .barrier-A .barrier-arm {
            width: 52px;
            height: 4px;
            left: 0;
            top: 0;
        }
        .barrier-A .barrier-post {
            left: -4px;
            top: -2px;
        }
        .barrier-C {
            width: 52px;
            height: 4px;
            top: 2px;
            left: 84%;
            transform: translateX(-50%);
        }
        .barrier-C .barrier-arm {
            width: 52px;
            height: 4px;
            left: 0;
            top: 0;
        }
        .barrier-C .barrier-post {
            right: -4px;
            top: -2px;
        }
        .barrier-B {
            width: 4px;
            height: 52px;
            left: 2px;
            top: 16%;
            transform: translateY(-50%);
        }
        .barrier-B .barrier-arm {
            width: 4px;
            height: 52px;
            left: 0;
            top: 0;
        }
        .barrier-B .barrier-post {
            left: -2px;
            top: -4px;
        }
        .barrier-D {
            width: 4px;
            height: 52px;
            right: 2px;
            top: 84%;
            transform: translateY(-50%);
        }
        .barrier-D .barrier-arm {
            width: 4px;
            height: 52px;
            left: 0;
            top: 0;
        }
        .barrier-D .barrier-post {
            left: -2px;
            bottom: -4px;
        }

        /* Sorompó melletti beviteli mezők */
        .barrier-input {
            position: static;
            z-index: 4;
        }
        .barrier-input[type="time.number"] {
            width: 12px !important;
        }
        .barrier-field {
            position: absolute;
            display: inline-flex;
            align-items: center;
            gap: 2px;
        }
        .barrier-unit {
            font-size: 7px;
            color: #000;
        }
        .corner.tl .barrier-field { right: 16px; bottom: 6px; }
        .corner.tr .barrier-field { left: 16px; bottom: 6px; }
        .corner.br .barrier-field { left: 16px; top: 6px; }
        .corner.bl .barrier-field { right: 16px; top: 6px; }

        /* Paraméterek (bal felső sarok) */
        .param-stack {
            position: absolute;
            left: 6px;
            top: 6px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            z-index: 3;
        }
        .param-row {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 7px;
            color: #000;
        }
        .param-icon {
            width: 14px;
            height: 14px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .param-icon img {
            width: 14px;
            height: 14px;
            display: block;
        }
        .param-icon svg {
            width: 14px;
            height: 14px;
            fill: #4a4a4a;
        }
        .param-input {
            width: 20px;
            min-width: 20px;
            max-width: 20px;
            font-size: 20px;
            text-align: center;
            padding: 0;
            border: none !important;
            outline: none;
            box-shadow: none;
            background: transparent;
            box-sizing: border-box;
            -moz-appearance: textfield;
        }
        .param-input::-webkit-outer-spin-button,
        .param-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .param-colon {
            font-size: 7px;
            color: #000;
            line-height: 1;
        }
        .param-unit {
            font-size: 7px;
            color: #000;
        }

        /* Sebesség tábla (jobb felső sarok) */
        .speed-sign {
            position: absolute;
            right: 6px;
            top: 6px;
            width: 34px;
            height: 34px;
            border: 7px solid #e10600;
            border-radius: 50%;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .speed-sign::after {
            content: "";
            position: absolute;
            left: -8.2px;
            top: -8.2px;
            width: calc(100% + 16px);
            height: calc(100% + 16px);
            border: .25px solid #111;
            border-radius: 50%;
            pointer-events: none;
        }
        .speed-sign input {
            width: 32px;
            height: 28px;
            line-height: 28px;
            font-size: 24px;
            font-weight: 600;
            text-align: center;
            border: none;
            background: transparent;
            outline: none;
            color: #000;
            font-family: Arial, sans-serif;
            padding: 0;
        }
        .speed-sign input::-webkit-outer-spin-button,
        .speed-sign input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .speed-sign input[type=number] {
            -moz-appearance: textfield;
        }

        /* ---------------- INAKTÍV (order 0) ÁG STÍLUS ---------------- */
        .cell.inactive {
            background: white !important;
            border: none !important;
        }

        .cell.center.border-A { border-top: var(--border-thick); }
        .cell.center.border-B { border-right: var(--border-thick); }
        .cell.center.border-C { border-bottom: var(--border-thick); }
        .cell.center.border-D { border-left: var(--border-thick); }

        /* ---------------- NYILAK (SVG) ---------------- */
        svg {
            width: 100%;
            height: 100%;
            overflow: visible; /* Hogy a nyilak "kilógjanak" kicsit a szomszédos cellákba ha kell */
        }

        .arrow-path {
            fill: var(--arrow-color);
            stroke: #6c8ecf;
            stroke-width: 0.5;
        }

    </style>
</head>
<body>

    <div class="container">
        <div class="cell corner tl">
            <div class="param-stack">
                <div class="param-row">
                    <span class="param-icon" aria-hidden="true">
                        <img src="car.png" alt="">
                    </span>
                    <span class="param-colon">:</span>
                    <input id="param-car-length" class="param-input" type="number" step="0.1">
                    <span class="param-unit">m</span>
                </div>
                <div class="param-row">
                    <span class="param-icon" aria-hidden="true">
                        <img src="driver.png" alt="">
                    </span>
                    <span class="param-colon">:</span>
                    <input id="param-driver-time" class="param-input" type="number" step="0.1">
                    <span class="param-unit">s</span>
                </div>
                <div class="param-row">
                    <span class="param-icon" aria-hidden="true">
                        <img src="accel.png" alt="">
                    </span>
                    <span class="param-colon">:</span>
                    <input id="param-accel" class="param-input" type="number" step="0.1">
                    <span class="param-unit">m/s<sup>2</sup></span>
                </div>
            </div>
            <div class="barrier-field">
                <input class="barrier-input barrier-input-A" type="time.number">
                <span class="barrier-unit">s</span>
            </div>
        </div>
        <div class="cell corner tr">
            <div class="speed-sign">
                <input id="param-vmax" type="number" step="1">
            </div>
            <div class="barrier-field">
                <input class="barrier-input barrier-input-B" type="time.number">
                <span class="barrier-unit">s</span>
            </div>
        </div>
        
        <div class="cell top">
            <input type="number" class="priority-number pos-A">
            
            <div class="check-wrapper check-AC">
                <input id="toggle-vertical" type="checkbox" title="AC tengely">
            </div>

            <div class="sign sign-A"></div>
            <div class="barrier barrier-A">
                <div class="barrier-arm"></div>
                <div class="barrier-post"></div>
            </div>

            <div class="data-group">
                <input type="vehicle.number">
                <div class="label">Jármű/h</div>
            </div>
            <div class="data-group">
                <input type="time.number">
                <div class="label">m</div>
            </div>
        </div>

        <div class="cell left">
            <input type="number" class="priority-number pos-D">

            <div class="check-wrapper check-BD">
                <input id="toggle-horizontal" type="checkbox" title="BD tengely">
            </div>

            <div class="sign sign-D"></div>
            <div class="barrier barrier-D">
                <div class="barrier-arm"></div>
                <div class="barrier-post"></div>
            </div>

            <div class="data-group">
                <input type="vehicle.number">
                <div class="label">Jármű/h</div>
            </div>
            <div class="data-group">
                <input type="time.number">
                <div class="label">m</div>
            </div>
        </div>

        <div class="cell center">
            <svg viewBox="0 0 200 200">
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                    refX="0" refY="3.5" orient="auto">
                      <polygon points="0 0, 10 3.5, 0 7" fill="#8da6d6" />
                    </marker>
                </defs>

                <polygon points="180,65 60,65 60,45 20,75 60,105 60,85 180,85" class="arrow-path arrow-horizontal" opacity="0.9"/>  <polygon points="20,135 140,135 140,155 180,125 140,95 140,115 20,115" class="arrow-path arrow-horizontal" opacity="0.9"/>  <polygon points="65,20 65,140 45,140 75,180 105,140 85,140 85,20" class="arrow-path arrow-vertical" opacity="0.9"/>  <polygon points="135,180 135,60 155,60 125,20 95,60 115,60 115,180" class="arrow-path arrow-vertical" opacity="0.9"/>  </svg>
            <div class="axis-hitbox ac" title="AC tengely"></div>
            <div class="axis-hitbox bd" title="BD tengely"></div>
            <div class="axis-hitbox both" title="AC + BD tengely"></div>
            <div class="axis-hitbox corner ab" title="AB tengely"></div>
            <div class="axis-hitbox corner bc" title="BC tengely"></div>
            <div class="axis-hitbox corner cd" title="CD tengely"></div>
            <div class="axis-hitbox corner ad" title="AD tengely"></div>
            <div class="axis-corner-indicator ab" title="AB"></div>
            <div class="axis-corner-indicator bc" title="BC"></div>
            <div class="axis-corner-indicator cd" title="CD"></div>
            <div class="axis-corner-indicator ad" title="AD"></div>
        </div>

        <div class="cell right">
            <input type="number" class="priority-number pos-B">

            <div class="sign sign-B"></div>
            <div class="barrier barrier-B">
                <div class="barrier-arm"></div>
                <div class="barrier-post"></div>
            </div>

            <div class="data-group">
                <input type="vehicle.number">
                <div class="label">Jármű/h</div>
            </div>
            <div class="data-group">
                <input type="time.number">
                <div class="label">m</div>
            </div>
        </div>

        <div class="cell bottom">
            <input type="number" class="priority-number pos-C">

            <div class="sign sign-C"></div>
            <div class="barrier barrier-C">
                <div class="barrier-arm"></div>
                <div class="barrier-post"></div>
            </div>

            <div class="data-group">
                <input type="vehicle.number">
                <div class="label">Jármű/h</div>
            </div>
            <div class="data-group">
                <input type="time.number">
                <div class="label">m</div>
            </div>
        </div>

        <div class="cell corner bl">
            <div class="barrier-field">
                <input class="barrier-input barrier-input-D" type="time.number">
                <span class="barrier-unit">s</span>
            </div>
        </div>
        <div class="cell corner br">
            <div class="barrier-field">
                <input class="barrier-input barrier-input-C" type="time.number">
                <span class="barrier-unit">s</span>
            </div>
        </div>

    </div>

    <script>
        // Toggle arrow visibility based on the two tengely (axis) checkbox states.
        const toggleHorizontal = document.getElementById('toggle-horizontal');
        const toggleVertical = document.getElementById('toggle-vertical');
        const hitboxAC = document.querySelector('.axis-hitbox.ac');
        const hitboxBD = document.querySelector('.axis-hitbox.bd');
        const hitboxBoth = document.querySelector('.axis-hitbox.both');
        const hitboxAB = document.querySelector('.axis-hitbox.ab');
        const hitboxBC = document.querySelector('.axis-hitbox.bc');
        const hitboxCD = document.querySelector('.axis-hitbox.cd');
        const hitboxAD = document.querySelector('.axis-hitbox.ad');
        const indicatorAB = document.querySelector('.axis-corner-indicator.ab');
        const indicatorBC = document.querySelector('.axis-corner-indicator.bc');
        const indicatorCD = document.querySelector('.axis-corner-indicator.cd');
        const indicatorAD = document.querySelector('.axis-corner-indicator.ad');
        const horizontalArrows = document.querySelectorAll('.arrow-horizontal');
        const verticalArrows = document.querySelectorAll('.arrow-vertical');
        const cornerAxes = { AB: false, BC: false, CD: false, AD: false };

        function refreshArrows(orderState = latestOrder) {
            const acAxis = toggleVertical.checked && (orderState?.A ?? 0) !== 0 && (orderState?.C ?? 0) !== 0;
            const bdAxis = toggleHorizontal.checked && (orderState?.B ?? 0) !== 0 && (orderState?.D ?? 0) !== 0;
            const cornerActive = {
                AB: (orderState?.A ?? 0) !== 0 && (orderState?.B ?? 0) !== 0,
                BC: (orderState?.B ?? 0) !== 0 && (orderState?.C ?? 0) !== 0,
                CD: (orderState?.C ?? 0) !== 0 && (orderState?.D ?? 0) !== 0,
                AD: (orderState?.A ?? 0) !== 0 && (orderState?.D ?? 0) !== 0,
            };

            horizontalArrows.forEach(el => {
                el.style.display = bdAxis ? 'inline' : 'none';
            });
            verticalArrows.forEach(el => {
                el.style.display = acAxis ? 'inline' : 'none';
            });
            if (indicatorAB) indicatorAB.classList.toggle('on', !!cornerAxes.AB && cornerActive.AB);
            if (indicatorBC) indicatorBC.classList.toggle('on', !!cornerAxes.BC && cornerActive.BC);
            if (indicatorCD) indicatorCD.classList.toggle('on', !!cornerAxes.CD && cornerActive.CD);
            if (indicatorAD) indicatorAD.classList.toggle('on', !!cornerAxes.AD && cornerActive.AD);
        }

        if (hitboxAC) {
            hitboxAC.addEventListener('click', () => {
                toggleVertical.checked = !toggleVertical.checked;
                refreshArrows(latestOrder);
            });
        }
        if (hitboxBD) {
            hitboxBD.addEventListener('click', () => {
                toggleHorizontal.checked = !toggleHorizontal.checked;
                refreshArrows(latestOrder);
            });
        }
        if (hitboxBoth) {
            hitboxBoth.addEventListener('click', (e) => {
                toggleVertical.checked = !toggleVertical.checked;
                toggleHorizontal.checked = !toggleHorizontal.checked;
                refreshArrows(latestOrder);
                e.stopPropagation();
            });
        }
        if (hitboxAB) {
            hitboxAB.addEventListener('click', (e) => {
                cornerAxes.AB = !cornerAxes.AB;
                refreshArrows(latestOrder);
                e.stopPropagation();
            });
        }
        if (hitboxBC) {
            hitboxBC.addEventListener('click', (e) => {
                cornerAxes.BC = !cornerAxes.BC;
                refreshArrows(latestOrder);
                e.stopPropagation();
            });
        }
        if (hitboxCD) {
            hitboxCD.addEventListener('click', (e) => {
                cornerAxes.CD = !cornerAxes.CD;
                refreshArrows(latestOrder);
                e.stopPropagation();
            });
        }
        if (hitboxAD) {
            hitboxAD.addEventListener('click', (e) => {
                cornerAxes.AD = !cornerAxes.AD;
                refreshArrows(latestOrder);
                e.stopPropagation();
            });
        }

        // -------- PRIORITY -> ORDER NUMBER (1-4) ----------
        const priorityInputs = {
            A: document.querySelector('.priority-number.pos-A'),
            B: document.querySelector('.priority-number.pos-B'),
            C: document.querySelector('.priority-number.pos-C'),
            D: document.querySelector('.priority-number.pos-D'),
        };

        const vehInputs = {
            A: document.querySelector('.cell.top input[type="vehicle.number"]'),
            B: document.querySelector('.cell.right input[type="vehicle.number"]'),
            C: document.querySelector('.cell.bottom input[type="vehicle.number"]'),
            D: document.querySelector('.cell.left input[type="vehicle.number"]'),
        };
        const barrierTimeInputs = {
            A: document.querySelector('.barrier-input-A'),
            B: document.querySelector('.barrier-input-B'),
            C: document.querySelector('.barrier-input-C'),
            D: document.querySelector('.barrier-input-D'),
        };

        function refreshBarrierLengths() {
            ['A', 'B', 'C', 'D'].forEach(arm => {
                const input = barrierTimeInputs[arm];
                const barrier = document.querySelector(`.barrier-${arm}`);
                if (!input || !barrier) return;
                const t = parseNumber(input.value) ?? 0;
                if (t <= 0) {
                    barrier.classList.add('open-short');
                } else {
                    barrier.classList.remove('open-short');
                }
            });
        }

        // -------- SOROMPÓK: kattintásra kar ki/be ----------
        document.querySelectorAll('.barrier').forEach(el => {
            const arm = ['A','B','C','D'].find(a => el.classList.contains(`barrier-${a}`));
            if (!arm) return;
            el.addEventListener('click', () => {
                setBarrierState(arm, !barrierState[arm]);
                updateBarrierVisibility(arm, latestOrder?.[arm] ?? 0);
            });
        });

        Object.values(barrierTimeInputs).forEach(inp => {
            if (!inp) return;
            inp.addEventListener('input', refreshBarrierLengths);
            inp.addEventListener('change', refreshBarrierLengths);
        });

        const passInputs = {
            A: document.querySelector('.cell.top input[type="time.number"]'),
            B: document.querySelector('.cell.right input[type="time.number"]'),
            C: document.querySelector('.cell.bottom input[type="time.number"]'),
            D: document.querySelector('.cell.left input[type="time.number"]'),
        };

        const extraInputs = {
            carLength: document.getElementById('param-car-length'),
            driverTime: document.getElementById('param-driver-time'),
            accel: document.getElementById('param-accel'),
            vmax: document.getElementById('param-vmax'),
        };

        const DEFAULTS = {
            priority: { A: 1, B: 2, C: 3, D: 0 },
            vehicles: { A: 0, B: 200, C: 300, D: 0 },
            passTime: { A: '6,0', B: '6,0', C: '6,0', D: '6,0' },
            barrierTime: { A: '6', B: '6', C: '6', D: '6' },
            axes: { AC: true, BD: true },
            barrierEnabled: { A: false, B: false, C: false, D: false },
            extra: { carLength: '4.8', driverTime: '0.8', accel: '2.0', vmax: '10' }
        };

        const barrierState = { A: true, B: true, C: true, D: true };

        function setBarrierState(arm, enabled) {
            barrierState[arm] = !!enabled;
            const barrier = document.querySelector(`.barrier-${arm}`);
            const field = document.querySelector(`.barrier-input-${arm}`)?.closest('.barrier-field');
            if (barrier) {
                barrier.classList.toggle('arm-hidden', !barrierState[arm]);
            }
            if (field) {
                field.style.display = barrierState[arm] ? '' : 'none';
            }
        }

        function updateBarrierVisibility(arm, ord) {
            const barrier = document.querySelector(`.barrier-${arm}`);
            const field = document.querySelector(`.barrier-input-${arm}`)?.closest('.barrier-field');
            const armActive = ord !== 0;
            if (barrier) {
                barrier.style.display = armActive ? '' : 'none';
                barrier.classList.toggle('arm-hidden', !barrierState[arm]);
            }
            if (field) {
                field.style.display = armActive && barrierState[arm] ? '' : 'none';
            }
        }

        function applyDefaults() {
            ['A', 'B', 'C', 'D'].forEach(arm => {
                if (priorityInputs[arm]) priorityInputs[arm].value = DEFAULTS.priority[arm];
                if (vehInputs[arm]) vehInputs[arm].value = DEFAULTS.vehicles[arm];
                if (passInputs[arm]) passInputs[arm].value = DEFAULTS.passTime[arm];
                if (barrierTimeInputs[arm]) barrierTimeInputs[arm].value = DEFAULTS.barrierTime[arm];
                setBarrierState(arm, DEFAULTS.barrierEnabled[arm]);
            });
            if (extraInputs.carLength) extraInputs.carLength.value = DEFAULTS.extra.carLength;
            if (extraInputs.driverTime) extraInputs.driverTime.value = DEFAULTS.extra.driverTime;
            if (extraInputs.accel) extraInputs.accel.value = DEFAULTS.extra.accel;
            if (extraInputs.vmax) extraInputs.vmax.value = DEFAULTS.extra.vmax;
            if (toggleVertical) toggleVertical.checked = !!DEFAULTS.axes.AC;
            if (toggleHorizontal) toggleHorizontal.checked = !!DEFAULTS.axes.BD;
        }

        const signElements = {
            A: document.querySelector('.sign-A'),
            B: document.querySelector('.sign-B'),
            C: document.querySelector('.sign-C'),
            D: document.querySelector('.sign-D'),
        };

        const armCells = {
            A: document.querySelector('.cell.top'),
            B: document.querySelector('.cell.right'),
            C: document.querySelector('.cell.bottom'),
            D: document.querySelector('.cell.left'),
        };
        const centerCell = document.querySelector('.cell.center');

        const rightOf = { A: 'B', B: 'C', C: 'D', D: 'A' };
        const opposite = { A: 'C', B: 'D', C: 'A', D: 'B' };

        // Színek (könnyen cserélhető, egymás alatt)
        const COLOR_GREEN  = '#2ecc71';
        const COLOR_YELLOW = '#f1c40f';
        const COLOR_ORANGE = '#e67e22';
        const COLOR_RED    = '#e74c3c';
        const COLOR_GRAY   = '#b3b3b3'; // order=0 esetén

        function parsePriority(value) {
            // magyar tizedesvessző támogatása
            const v = parseFloat(String(value).replace(',', '.'));
            return Number.isNaN(v) ? Infinity : v;
        }

        function parseNumber(value) {
            const v = parseFloat(String(value).replace(',', '.'));
            return Number.isNaN(v) ? null : v;
        }

        let latestOrder = {};

        function computeOrders() {
            const valueToArms = new Map();
            const order = {};
            ['A', 'B', 'C', 'D'].forEach(arm => {
                const val = parsePriority(priorityInputs[arm]?.value);
                if (!Number.isFinite(val) || val <= 0) {
                    order[arm] = 0; // hibás vagy 0 priority -> order 0
                    return;
                }
                if (!valueToArms.has(val)) valueToArms.set(val, []);
                valueToArms.get(val).push(arm);
            });

            const uniqueValues = Array.from(valueToArms.keys()).sort((a, b) => a - b);
            let rank = 1;

            uniqueValues.forEach(val => {
                const arms = valueToArms.get(val);
                if (!arms) return;

                if (arms.length >= 3) {
                    // 3 vagy 4 azonos priority -> azonos order szám
                    arms.forEach(a => { order[a] = rank; });
                    rank += 1;
                } else if (arms.length === 2) {
                    const [a, b] = arms;
                    if (opposite[a] === b) {
                        // szemközti azonos priority -> azonos order
                        order[a] = order[b] = rank;
                        rank += 1;
                    } else {
                        // szomszédos azonos priority -> jobbra lévő kapja a nagyobb számot (fordított sorrend)
                        if (rightOf[a] === b) {
                            order[a] = rank;
                            order[b] = rank + 1;
                        } else {
                            order[b] = rank;
                            order[a] = rank + 1;
                        }
                        rank += 2;
                    }
                } else if (arms.length === 1) {
                    order[arms[0]] = rank;
                    rank += 1;
                }
            });

            latestOrder = order;
            applyOrderColors(order);
            refreshArrows(order);
        }

        function applyOrderColors(order) {
            const orders = Object.values(order ?? {});
            const distinct = Array.from(new Set(orders.filter(v => v !== undefined && v !== 0))).sort((a, b) => a - b);

            let palette = [];
            if (distinct.length >= 4) {
                palette = [COLOR_GREEN, COLOR_YELLOW, COLOR_ORANGE, COLOR_RED];
            } else if (distinct.length === 3) {
                palette = [COLOR_GREEN, COLOR_YELLOW, COLOR_RED];
            } else if (distinct.length === 2) {
                palette = [COLOR_GREEN, COLOR_RED];
            } else if (distinct.length === 1) {
                palette = [COLOR_GREEN];
            }

            const orderToColor = new Map();
            distinct.forEach((ord, idx) => {
                orderToColor.set(ord, palette[idx] ?? COLOR_GREEN);
            });
            orderToColor.set(0, COLOR_GRAY);

            const centerBorders = ['border-A','border-B','border-C','border-D'];
            if (centerCell) centerBorders.forEach(cls => centerCell.classList.remove(cls));

            ['A', 'B', 'C', 'D'].forEach(arm => {
                const sign = signElements[arm];
                const cell = armCells[arm];
                if (!sign) return;
                const ord = order[arm];
                if (ord === 0) {
                    sign.style.display = 'none';
                    sign.textContent = '';
                    sign.style.backgroundColor = COLOR_GRAY;
                  } else {
                      sign.style.display = 'flex';
                      sign.textContent = arm;
                      const color = orderToColor.get(ord) ?? '#ffffff';
                      sign.style.backgroundColor = color;
                  }

                if (cell) {
                    if (ord === 0) {
                        cell.classList.add('inactive');
                    } else {
                        cell.classList.remove('inactive');
                    }
                    cell.querySelectorAll('.data-group').forEach(group => {
                        group.style.display = ord === 0 ? 'none' : '';
                    });
                }

                updateBarrierVisibility(arm, ord);

                if (centerCell && ord === 0) {
                    centerCell.classList.add(`border-${arm}`);
                }
            });
        }

        toggleHorizontal.addEventListener('change', () => refreshArrows(latestOrder));
        toggleVertical.addEventListener('change', () => refreshArrows(latestOrder));

        Object.values(priorityInputs).forEach(inp => {
            if (!inp) return;
            inp.addEventListener('input', computeOrders);
            inp.addEventListener('change', computeOrders);
        });

        applyDefaults();
        refreshArrows(latestOrder);
        computeOrders();
        refreshBarrierLengths();

        // Adatkiolvasás a szülő számára
        window.getCrossData = function getCrossData() {
            // frissítjük az order-öket
            computeOrders();
            const priorities = {
                A: parseNumber(priorityInputs.A?.value),
                B: parseNumber(priorityInputs.B?.value),
                C: parseNumber(priorityInputs.C?.value),
                D: parseNumber(priorityInputs.D?.value),
            };
            const vehicles = {
                A: parseNumber(vehInputs.A?.value),
                B: parseNumber(vehInputs.B?.value),
                C: parseNumber(vehInputs.C?.value),
                D: parseNumber(vehInputs.D?.value),
            };
            const passTimes = {
                A: parseNumber(passInputs.A?.value),
                B: parseNumber(passInputs.B?.value),
                C: parseNumber(passInputs.C?.value),
                D: parseNumber(passInputs.D?.value),
            };
            const extra = {
                carLength: parseNumber(extraInputs.carLength?.value),
                driverTime: parseNumber(extraInputs.driverTime?.value),
                accel: parseNumber(extraInputs.accel?.value),
                vmax: parseNumber(extraInputs.vmax?.value),
            };
            const barrierTimes = {
                A: barrierState.A ? (parseNumber(barrierTimeInputs.A?.value) ?? 0) : 0,
                B: barrierState.B ? (parseNumber(barrierTimeInputs.B?.value) ?? 0) : 0,
                C: barrierState.C ? (parseNumber(barrierTimeInputs.C?.value) ?? 0) : 0,
                D: barrierState.D ? (parseNumber(barrierTimeInputs.D?.value) ?? 0) : 0,
            };
            const barriers = { ...barrierState };

            const axes = {
                AC_checked: !!toggleVertical.checked,
                BD_checked: !!toggleHorizontal.checked,
                AC_active: !!(toggleVertical.checked && (latestOrder.A ?? 0) !== 0 && (latestOrder.C ?? 0) !== 0),
                BD_active: !!(toggleHorizontal.checked && (latestOrder.B ?? 0) !== 0 && (latestOrder.D ?? 0) !== 0),
                AB_checked: !!cornerAxes.AB,
                BC_checked: !!cornerAxes.BC,
                CD_checked: !!cornerAxes.CD,
                AD_checked: !!cornerAxes.AD,
                AB_active: !!(cornerAxes.AB && (latestOrder.A ?? 0) !== 0 && (latestOrder.B ?? 0) !== 0),
                BC_active: !!(cornerAxes.BC && (latestOrder.B ?? 0) !== 0 && (latestOrder.C ?? 0) !== 0),
                CD_active: !!(cornerAxes.CD && (latestOrder.C ?? 0) !== 0 && (latestOrder.D ?? 0) !== 0),
                AD_active: !!(cornerAxes.AD && (latestOrder.A ?? 0) !== 0 && (latestOrder.D ?? 0) !== 0),
            };

            return {
                priorities,
                orders: { ...latestOrder },
                vehicles,
                passTimes,
                extra,
                barrierTimes,
                barriers,
                axes,
            };
        };

        // postMessage válasz a szülő kérésére (cross-origin safe)
        window.addEventListener('message', (event) => {
            const data = event.data;
            if (!data || data.type !== 'request-cross-data') return;
            const payload = window.getCrossData();
            if (event.source && typeof event.source.postMessage === 'function') {
                event.source.postMessage({ type: 'cross-data', payload }, '*');
            }
        });
    </script>

</body>
</html>
